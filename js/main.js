/*
    load an Image
    snapshot the element inwhich the image exists
    append the canvas to the body
    process
*/
var __canvas = document.querySelector('#stage');
var __stage;
var __cat,__catctx;

var __content = document.querySelector('.content');

var catImage = new Image();

var canvasDivider;

catImage.onload = function(){
    html2canvas(__content, {
        onrendered: function(canvas) {
            __cat = canvas;
            __catctx = canvas.getContext("2d");
            init();
        }
    });
};
catImage.src = "img/300.jpg"

//shapes for testing
//as generated by http://codepen.io/cmndo/pen/oXoZGo
var shapes = [[{"x":105,"y":147},{"x":149,"y":58},{"x":230,"y":59},{"x":180,"y":153}],[{"x":296,"y":106},{"x":328,"y":37},{"x":414,"y":38},{"x":388,"y":88},{"x":345,"y":71},{"x":340,"y":109},{"x":320,"y":124},{"x":295,"y":105}],[{"x":297,"y":104},{"x":325,"y":123},{"x":341,"y":104},{"x":388,"y":87},{"x":411,"y":124},{"x":390,"y":170},{"x":259,"y":171},{"x":297,"y":105}],[{"x":413,"y":123},{"x":389,"y":89},{"x":423,"y":21},{"x":487,"y":22},{"x":437,"y":129},{"x":409,"y":123}],[{"x":106,"y":142},{"x":146,"y":60},{"x":93,"y":31},{"x":56,"y":105},{"x":92,"y":93},{"x":106,"y":139}]];

function getBounds(points){
    // find the boundary that makes up the shape
    var sx, sy, lx, ly;

    for(var i = 0; i < points.length; i++){
        //find the smallests
        if(points[i].x < sx || sx === undefined){
            sx = points[i].x;
        }
        if(points[i].y < sy || sy === undefined){
            sy = points[i].y;
        }
        //find the biggest
        if(points[i].x > lx || lx === undefined){
            lx = points[i].x;
        }
        if(points[i].y > ly || ly === undefined){
            ly = points[i].y;
        }
        //now we should have a set of boundaries
    }

    return {
        x: sx,
        y: sy,
        width: lx - sx,
        height: ly - sy
    }
}

//class for handling the canvas split
function CanvasDivider(){


    this.slice = function( currShape, alternate, delay ){
        //1. create faux canvas the same size as the screenshot
        var tempCanvas = document.createElement("canvas");
        tempCanvas.height = __cat.height;
        tempCanvas.width = __cat.width;



        //2. draw your clipping mask on it
        var ctx = tempCanvas.getContext("2d");

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(shapes[currShape][0].x, shapes[currShape][0].y);
        for(i = 0; i < shapes[currShape].length; i++){
            ctx.lineTo(shapes[currShape][i].x, shapes[currShape][i].y);
        }
        ctx.closePath();
        ctx.clip();

        //3. put your image on the clipping mask
        ctx.drawImage(__cat, 0, 0);
        ctx.restore();

        //4. get image data of the bounding box
        var bounds = getBounds(shapes[currShape]);
        var imageData = ctx.getImageData(bounds.x,bounds.y,bounds.width,bounds.height);


        //5. paste it into a createjs bitmap
        var bmpCanvas = document.createElement("canvas");
        bmpCanvas.width = bounds.width;
        bmpCanvas.height = bounds.height;

        var bmpCtx = bmpCanvas.getContext("2d");
        bmpCtx.putImageData(imageData, 0, 0);
        var bmp = new createjs.Bitmap(bmpCanvas);
        bmp.x = bounds.x;
        bmp.y = bounds.y;

        console.log("frog");

        //6. Add to stage
        __stage.addChild(bmp);

        //7. update stage
        __stage.update();


        console.log("at least i know it finished processing this block");


        if(alternate){
            TweenLite.to(bmp, 1, {delay: delay, x: bounds.x + 100, y:bounds.y - 180, rotation: 20, onUpdate:__stage.update, onUpdateScope:__stage, ease: Quad.easeIn} );
        }else{
            TweenLite.to(bmp, 1, {delay: delay, x: bounds.x - 100, y:bounds.y + 180, rotation: -50, onUpdate:__stage.update, onUpdateScope:__stage, ease: Quad.easeIn} );
        }

    }
}

function init(){
    __stage = new createjs.Stage("stage");
    canvasDivider = new CanvasDivider();

    for(var i = 0; i < shapes.length; i++){
        canvasDivider.slice(i, (i%2==0), i * .1);
    }

    //put the effect in place of the element

}
