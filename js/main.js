/*
    load an Image
    snapshot the element inwhich the image exists
    append the canvas to the body
    process
*/
var __canvas = document.querySelector('#stage');
var __stage;
var __cat,__catctx;

var __content = document.querySelector('.content');

var catImage = new Image();

var canvasDivider;

catImage.onload = function(){
    html2canvas(__content, {
        onrendered: function(canvas) {
            __cat = canvas;
            __catctx = canvas.getContext("2d");
            init();
        }
    });
};
catImage.src = "img/300.jpg"

//shapes for testing
//as generated by http://codepen.io/cmndo/pen/oXoZGo
var shapes = [[{"x":2,"y":0},{"x":21,"y":0},{"x":2,"y":22}],[{"x":23,"y":1},{"x":53,"y":1},{"x":3,"y":103},{"x":3,"y":23}],[{"x":54,"y":0},{"x":106,"y":0},{"x":18,"y":174},{"x":3,"y":174},{"x":3,"y":101}],[{"x":19,"y":172},{"x":107,"y":2},{"x":121,"y":0},{"x":30,"y":173}],[{"x":32,"y":172},{"x":121,"y":1},{"x":175,"y":1},{"x":86,"y":172}],[{"x":91,"y":173},{"x":180,"y":0},{"x":215,"y":0},{"x":142,"y":174}],[{"x":143,"y":173},{"x":217,"y":1},{"x":229,"y":1},{"x":154,"y":173}],[{"x":156,"y":174},{"x":232,"y":1},{"x":259,"y":2},{"x":170,"y":174}],[{"x":172,"y":174},{"x":261,"y":1},{"x":348,"y":1},{"x":259,"y":172}],[{"x":260,"y":172},{"x":348,"y":0},{"x":368,"y":0},{"x":281,"y":173}],[{"x":281,"y":173},{"x":369,"y":1},{"x":416,"y":0},{"x":330,"y":174}],[{"x":331,"y":173},{"x":417,"y":1},{"x":434,"y":0},{"x":345,"y":174}],[{"x":347,"y":172},{"x":390,"y":88},{"x":456,"y":88},{"x":412,"y":174}],[{"x":390,"y":88},{"x":436,"y":1},{"x":502,"y":0},{"x":456,"y":88}],[{"x":504,"y":1},{"x":520,"y":0},{"x":432,"y":174},{"x":414,"y":174}],[{"x":433,"y":173},{"x":523,"y":1},{"x":538,"y":3},{"x":538,"y":45},{"x":472,"y":174}],[{"x":473,"y":172},{"x":538,"y":49},{"x":538,"y":116},{"x":509,"y":174}],[{"x":512,"y":173},{"x":538,"y":118},{"x":538,"y":174}]];
function getBounds(points){
    // find the boundary that makes up the shape
    var sx, sy, lx, ly;

    for(var i = 0; i < points.length; i++){
        //find the smallests
        if(points[i].x < sx || sx === undefined){
            sx = points[i].x;
        }
        if(points[i].y < sy || sy === undefined){
            sy = points[i].y;
        }
        //find the biggest
        if(points[i].x > lx || lx === undefined){
            lx = points[i].x;
        }
        if(points[i].y > ly || ly === undefined){
            ly = points[i].y;
        }
        //now we should have a set of boundaries
    }

    return {
        x: sx,
        y: sy,
        width: lx - sx,
        height: ly - sy
    }
}

//class for handling the canvas split
function CanvasDivider(){


    this.slice = function( currShape, alternate, delay ){
        //1. create faux canvas the same size as the screenshot
        var tempCanvas = document.createElement("canvas");
        tempCanvas.height = __cat.height;
        tempCanvas.width = __cat.width;



        //2. draw your clipping mask on it
        var ctx = tempCanvas.getContext("2d");

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(shapes[currShape][0].x, shapes[currShape][0].y);
        for(i = 0; i < shapes[currShape].length; i++){
            ctx.lineTo(shapes[currShape][i].x, shapes[currShape][i].y);
        }
        ctx.closePath();
        ctx.clip();

        //3. put your image on the clipping mask
        ctx.drawImage(__cat, 0, 0);
        ctx.restore();

        //4. get image data of the bounding box
        var bounds = getBounds(shapes[currShape]);
        var imageData = ctx.getImageData(bounds.x,bounds.y,bounds.width,bounds.height);


        //5. paste it into a createjs bitmap
        var bmpCanvas = document.createElement("canvas");
        bmpCanvas.width = bounds.width;
        bmpCanvas.height = bounds.height;

        var bmpCtx = bmpCanvas.getContext("2d");
        bmpCtx.putImageData(imageData, 0, 0);
        var bmp = new createjs.Bitmap(bmpCanvas);
        bmp.x = bounds.x;
        bmp.y = bounds.y;

        console.log("frog");

        //6. Add to stage
        __stage.addChild(bmp);

        //7. update stage
        __stage.update();


        console.log("at least i know it finished processing this block");


        if(alternate){
            TweenLite.to(bmp, 1, {delay: delay, x: bounds.x + 100, y:bounds.y - 180, onUpdate:__stage.update, onUpdateScope:__stage, ease: Expo.easeInOut} );
        }else{
            TweenLite.to(bmp, 1, {delay: delay, x: bounds.x - 100, y:bounds.y + 180, onUpdate:__stage.update, onUpdateScope:__stage, ease: Expo.easeInOut} );
        }

    }
}

function init(){
    __stage = new createjs.Stage("stage");
    canvasDivider = new CanvasDivider();

    for(var i = 0; i < shapes.length; i++){
        canvasDivider.slice(i, (i%2==0), Math.random() * (shapes.length * .01));
    }

    //put the effect in place of the element

}
